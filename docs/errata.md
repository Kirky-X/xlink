# 统一多通道推送SDK - 文档修正补丁 (ERRATA)

**文档版本**: v1.1  
**修正日期**: 2025-12-19  
**修正原因**: 解决PRD、TDD、TEST、UAT之间的不一致性  
**影响文档**: PRD v1.0, TDD v1.0, TEST v1.0, UAT v1.0

---

## 📋 修正概述

本修正文档旨在解决四份核心文档之间发现的关键差异和不一致之处，包括：
1. 功能覆盖差异
2. 性能指标表述不一致
3. 术语使用不统一
4. 技术设计超出需求范围

---

## 🔴 关键修正项

### 修正1: 功能覆盖统一

#### 问题
- F9（成本感知路由）：PRD标记为P1，但TEST测试覆盖不足
- F10（分布式存储）：PRD标记为P2，但TEST和UAT完全无覆盖

#### 修正方案

**PRD修正 - 功能优先级调整**:
```diff
+ F9: 成本感知路由
- 优先级: P1 (Should Have)
+ 优先级: P1 (Should Have) - Phase 2交付
+ 最小可验收标准: 识别WiFi/移动网络，流量统计

+ F10: 分布式存储集成
- 优先级: P2 (Nice to Have)
+ 优先级: P3 (Future) - 不纳入v1.0范围
+ 说明: 功能推迟到v2.0，v1.0不做测试和验收
```

**TEST修正 - 补充测试用例**:
```diff
+ 新增章节: 5.5 成本感知路由测试

| 测试ID | 场景 | 配置 | 目标 | 测试方法 |
|--------|------|------|------|----------|
| PERF-COST-001 | 网络类型识别 | WiFi/4G/5G | 准确识别 | 切换网络验证识别 |
| PERF-COST-002 | 流量统计 | 发送100MB数据 | 精确统计±5% | 对比系统统计 |
| PERF-COST-003 | 成本优先路由 | 仅WiFi模式 | 拒绝移动数据 | 在4G下发送验证 |
| PERF-COST-004 | 流量预警 | 超过阈值 | 发送通知 | 设置100MB阈值测试 |

+ F10分布式存储: 标记为"v2.0功能，不测试"
```

**UAT修正 - 补充验收用例**:
```diff
+ 3.2.3 成本感知路由验收

| 用例ID | 场景 | 测试步骤 | 验收标准 |
|--------|------|----------|----------|
| UAT-F-033 | 网络类型识别 | 1. 连接WiFi<br>2. 切换到4G | - WiFi识别为免费<br>- 4G识别为计费 |
| UAT-F-034 | 流量统计准确性 | 1. 发送10MB文件<br>2. 查看统计 | - 误差<5%<br>- 分通道统计 |
| UAT-F-035 | 仅WiFi模式 | 1. 开启仅WiFi<br>2. 在4G下发送 | - 拒绝发送<br>- 提示等待WiFi |
| UAT-F-036 | 流量预警 | 1. 设置50MB限制<br>2. 发送文件 | - 接近限制时预警<br>- 超过限制时阻止 |
```

---

### 修正2: 性能指标统一

#### 问题
- 消息送达率: PRD要求>99.9%，TEST写>99%，UAT写100%
- 群组规模: PRD支持1000人，TEST只测50人
- 大文件: PRD支持100MB，TEST缺乏详细方案

#### 修正方案

**统一的性能指标表**:

| 指标 | PRD要求 | TEST目标 | UAT验收标准 | 测试方法 |
|------|---------|----------|-------------|----------|
| **可靠性** |
| 消息送达率（正常网络） | ≥99.9% | ≥99.9% | ≥99.9% | 发送10,000条消息统计 |
| 消息送达率（弱网环境） | ≥95% | ≥95% | ≥95% | 20%丢包率下测试 |
| 崩溃率 | <0.1% | <0.1% | 0次崩溃 | 100万次操作监控 |
| **延迟** |
| SDK初始化 | <2秒 | <2秒 | ≤2秒 | 冷启动10次平均 |
| 近场消息（BLE） | <100ms | <100ms | ≤100ms | 往返100次，P95<100ms |
| 远程消息（ntfy） | <500ms | <500ms | ≤500ms | 往返100次，P95<500ms |
| 群组广播（10人） | <200ms | <200ms | 95%≤200ms | 所有成员接收时间 |
| 通道切换 | <2秒 | <2秒 | ≤2秒 | 模拟切换10次 |
| **资源占用** |
| 内存占用 | <50MB | <50MB | ≤50MB | 运行1小时监控峰值 |
| CPU占用（空闲） | <1% | <1% | ≤1% | 后台运行1小时平均 |
| CPU占用（忙碌） | <20% | <20% | ≤20% | 每秒100条消息时 |
| 电量消耗（24h） | <5% | <5% | ≤5% | 后台心跳模式 |
| 存储占用（7天） | <100MB | <100MB | ≤100MB | 日常使用场景 |
| **吞吐量** |
| BLE通道 | 100条/秒 | ≥100条/秒 | ≥100条/秒 | 发送1000条小消息 |
| WiFi Direct | 500条/秒 | ≥500条/秒 | ≥500条/秒 | 并行传输测试 |
| 群组广播（10人） | 50条/秒 | ≥50条/秒 | ≥50条/秒 | 连续广播500条 |
| **群组规模** |
| 小群组（快速） | 10人 | 10人 | 10人 | 广播延迟<200ms |
| 中群组（标准） | 100人 | 100人 | 50人 | 95%在5秒内收到 |
| 大群组（支持） | 1000人 | 500人 | 200人 | 能创建和管理 |
| **文件传输** |
| 小文件 | <5MB | <5MB | 5MB | 传输成功，<30秒 |
| 中文件 | <50MB | <50MB | 50MB | 支持断点续传 |
| 大文件 | <100MB | <100MB | 100MB | WiFi Direct传输 |

**说明**:
- TEST目标 = 开发和测试阶段的目标值
- UAT验收标准 = 最终验收通过的阈值
- 群组规模采用分级测试：10/50/100/200/500/1000人
- 消息送达率统一为≥99.9%（正常网络），弱网≥95%

**PRD修正**:
```diff
3.1 性能要求
- 消息送达率: > 99.9%（网络正常情况）
+ 消息送达率: ≥ 99.9%（正常网络），≥ 95%（弱网）
+ 群组规模支持: 分级测试 10/50/100/500/1000人
+ 文件传输: 小(<5MB)、中(<50MB)、大(<100MB)
```

**TEST修正**:
```diff
+ 5.4 群组规模压力测试

| 测试ID | 群组规模 | 测试内容 | 目标 |
|--------|----------|----------|------|
| PERF-GRP-001 | 10人 | 广播100条消息 | 每条<200ms，100%送达 |
| PERF-GRP-002 | 50人 | 广播100条消息 | 95%在5秒内，≥99%送达 |
| PERF-GRP-003 | 100人 | 广播50条消息 | 95%在5秒内，≥95%送达 |
| PERF-GRP-004 | 200人 | 创建群组并发送 | 创建成功，能正常通信 |
| PERF-GRP-005 | 500人 | 创建群组 | 创建成功，能力矩阵生成 |

+ 5.5 大文件传输测试

| 测试ID | 文件大小 | 通道 | 目标 | 测试方法 |
|--------|----------|------|------|----------|
| PERF-FILE-001 | 5MB | BLE | <2分钟，支持分包 | 图片传输 |
| PERF-FILE-002 | 5MB | WiFi Direct | <10秒 | 图片传输 |
| PERF-FILE-003 | 50MB | WiFi Direct | <30秒，断点续传 | 视频传输 |
| PERF-FILE-004 | 100MB | WiFi Direct | <2分钟，断点续传 | 大视频传输 |
| PERF-FILE-005 | 100MB | 网络中断恢复 | 从断点继续 | 传输中断开WiFi |
```

**UAT修正**:
```diff
+ 4.4 群组规模验收

| 规模 | 验收标准 | 测试方法 |
|------|----------|----------|
| 10人 | 广播延迟<200ms，100%送达 | 实际10台设备测试 |
| 50人 | 95%在5秒内收到 | 50台设备或模拟器 |
| 100人 | 95%在5秒内收到 | 模拟测试 |
| 200人 | 能创建和管理 | 模拟测试 |

+ 4.5 文件传输验收

| 文件大小 | 验收标准 | 测试方法 |
|----------|----------|----------|
| 5MB图片 | WiFi Direct <10秒 | 实际传输 |
| 50MB视频 | <30秒，支持断点续传 | 中途断开恢复 |
| 100MB视频 | <2分钟，支持断点续传 | 完整传输测试 |
```

---

### 修正3: 术语统一

#### 问题
- 设备类型命名不统一
- TDD使用了PRD未定义的术语

#### 修正方案

**统一的术语表**:

| 术语 | 标准定义 | 使用规范 | 出处 |
|------|----------|----------|------|
| **设备类型** |
| 智能手机 | Smartphone | Android/iOS手机 | PRD, TDD, TEST, UAT |
| 平板电脑 | Tablet | Android/iOS平板 | PRD, TDD, TEST, UAT |
| 笔记本电脑 | Laptop | 便携式计算机 | PRD, TDD, TEST, UAT |
| 台式电脑 | Desktop | 桌面计算机 | PRD, TDD, TEST, UAT |
| 服务器 | Server | 服务器设备 | PRD, TDD, TEST, UAT |
| IoT设备 | IoT Device | 物联网设备 | PRD, TDD, TEST, UAT |
| 开发板 | Development Board | 嵌入式开发板（如树莓派） | PRD, TDD, TEST, UAT |
| **通道类型** |
| 蓝牙BLE | Bluetooth LE / BluetoothLE | 蓝牙低功耗 | PRD, TDD, TEST, UAT |
| 经典蓝牙 | Bluetooth Classic / BluetoothClassic | 传统蓝牙 | PRD, TDD, TEST, UAT |
| WiFi Direct | WiFi Direct / WiFiDirect | WiFi点对点 | PRD, TDD, TEST, UAT |
| 蓝牙Mesh | Bluetooth Mesh / BluetoothMesh | 蓝牙网状网络 | PRD, TDD, TEST, UAT |
| 远程通道 | Remote Channel | 互联网通道（ntfy/WebSocket） | PRD, TDD, TEST, UAT |
| **加密相关** |
| TreeKEM | TreeKEM | 树状密钥封装机制 | PRD, TDD, TEST, UAT |
| ECDH | ECDH | 椭圆曲线Diffie-Hellman密钥交换 | PRD, TDD, TEST, UAT |
| 前向保密 | Forward Secrecy / PFS | 历史消息保护 | PRD, TDD, TEST, UAT |
| **路由相关** |
| 通道选择 | Channel Selection | 路由决策 | PRD, TDD, TEST, UAT |
| 多因素评分 | Multi-factor Scoring | 路由评分模型 | PRD, TDD, TEST, UAT |
| 预测性路由 | Predictive Routing | 提前切换 | PRD, TDD, TEST, UAT |
| **群组相关** |
| 群组广播 | Group Broadcast | 群组消息分发 | PRD, TDD, TEST, UAT |
| 拓扑分析 | Topology Analysis | 成员连接关系分析 | PRD, TDD, TEST, UAT |
| 超级节点 | Super Node | 中继节点 | PRD, TDD, TEST, UAT |
| **消息相关** |
| 消息确认 | Acknowledgment / ACK | 消息回执 | PRD, TDD, TEST, UAT |
| 离线队列 | Offline Queue | 离线消息缓存 | PRD, TDD, TEST, UAT |
| 消息优先级 | Message Priority | Critical/High/Normal/Low | PRD, TDD, TEST, UAT |

**新增术语（TDD特有，需在PRD中补充）**:

| 术语 | 定义 | 添加到PRD | 说明 |
|------|------|-----------|------|
| GATT | Generic Attribute Profile | ✅ 添加 | 蓝牙BLE的通信协议 |
| MTU | Maximum Transmission Unit | ✅ 添加 | 最大传输单元 |
| AODV | Ad-hoc On-Demand Distance Vector | ✅ 添加 | Mesh网络路由协议 |
| Bloom Filter | 布隆过滤器 | ✅ 添加 | 消息去重数据结构 |
| CRC32 | 循环冗余校验 | ✅ 添加 | 数据完整性校验 |
| HKDF | HMAC-based Key Derivation Function | ✅ 添加 | 密钥派生函数 |
| nonce | Number used once | ✅ 添加 | 一次性随机数 |
| TTL | Time To Live | ✅ 添加 | 生存时间/跳数限制 |

**PRD修正 - 新增术语表章节**:
```diff
+ 9. 技术术语表

本章节定义SDK中使用的技术术语，确保团队沟通一致。

## 9.1 通信协议术语

| 术语 | 全称 | 定义 |
|------|------|------|
| GATT | Generic Attribute Profile | 蓝牙BLE的应用层协议，定义数据交换方式 |
| MTU | Maximum Transmission Unit | 单次传输的最大数据包大小 |
| TTL | Time To Live | 消息或包的生存时间，用于防止无限循环 |
| AODV | Ad-hoc On-Demand Distance Vector | 用于Mesh网络的按需路由协议 |

## 9.2 数据结构术语

| 术语 | 定义 | 用途 |
|------|------|------|
| Bloom Filter | 概率性数据结构 | 高效的消息去重，可能有极低误判率 |
| CRC32 | 32位循环冗余校验 | 检测数据传输错误 |

## 9.3 加密术语

| 术语 | 全称 | 定义 |
|------|------|------|
| HKDF | HMAC-based KDF | 从共享密钥派生会话密钥 |
| nonce | Number used once | 加密时的一次性随机数，防止重放 |
| MAC | Message Authentication Code | 消息认证码，验证完整性和来源 |

注: 这些术语主要在TDD中详细使用，PRD层面了解即可。
```

**TDD修正 - 术语引用**:
```diff
在每个使用高级术语的章节开头添加说明:

+ 3.1.1 蓝牙BLE通道
+ 
+ 本节使用的技术术语:
+ - GATT: 蓝牙BLE的应用层协议（详见PRD术语表9.1）
+ - MTU: 最大传输单元（详见PRD术语表9.1）
+ - CRC32: 循环冗余校验（详见PRD术语表9.2）

类似地为其他章节添加术语引用。
```

---

### 修正4: 技术设计范围控制

#### 问题
TDD包含过多实现细节，超出PRD范围

#### 修正方案

**TDD章节调整**:

```diff
重新分类TDD内容:

+ 核心设计（必须包含）:
  - 架构设计
  - 模块划分
  - 数据模型
  - 关键算法（路由、加密、群组）
  - 接口定义

+ 实现指导（可选参考）:
  - TCP参数调优
  - GATT特征值设计
  - Bloom Filter实现
  - 具体的代码示例

+ 新增章节标识:
  标记"核心设计"和"实现参考"章节
```

**TDD修正 - 章节重组**:

```diff
- 3.1.1 蓝牙BLE通道（混合核心设计和实现细节）

+ 3.1.1 蓝牙BLE通道 - 核心设计
+
+ **架构决策**:
+ - 使用GATT协议进行数据交换
+ - 支持Central和Peripheral双角色
+ - MTU协商以优化传输
+ - 自动重连机制
+
+ **服务设计**:
+ - 主服务UUID: 0x7F50
+ - 3个特征值: 控制、数据、能力
+ - 详细特征值定义见实现参考
+
+ **连接管理策略**:
+ - 连接池: 最多5个活跃连接
+ - 优先级分级: P0保持、P1保持、P2临时
+ - 超时机制: 连接30秒、空闲5分钟
+
+ **大消息传输**:
+ - 自动分包策略
+ - 使用序列号和校验和
+ - 重组超时30秒
+
+ ---
+
+ 3.1.1.A 蓝牙BLE通道 - 实现参考（可选）
+
+ 本节提供详细的实现建议，可根据实际情况调整。
+
+ **广播数据格式**（示例）:
+ - Service UUID: 0x7F50
+ - Manufacturer Data格式: [详细字节布局]
+ - 注: 具体格式可在实现时优化
+
+ **GATT服务详细定义**（示例）:
+ [详细的UUID、属性、格式定义]
+
+ **分包协议**（示例）:
+ - 包头格式: [序列号2字节 | 总包数2字节 | CRC32 4字节]
+ - 注: CRC32是一种可选的校验方式，也可使用其他方案
```

**类似地重组其他章节**，将核心设计与实现细节分离。

**PRD修正 - 明确设计边界**:
```diff
+ 2.6 设计原则和约束

## 2.6.1 设计范围
- PRD: 定义"做什么"（功能需求、性能指标、用户价值）
- TDD: 定义"怎么做"（架构、算法、接口），分为核心设计和实现参考
- TEST: 定义"如何验证"（测试用例、验收标准）

## 2.6.2 技术决策层级
- **架构级决策**（PRD + TDD核心）: 必须明确的关键技术选择
  - 例: 使用TreeKEM进行群组加密
  - 例: 采用多因素评分进行路由选择
  
- **实现级决策**（TDD实现参考）: 可调整的具体实现方式
  - 例: CRC32校验（可替换为其他校验方式）
  - 例: TCP参数调优（可根据平台调整）
  
- **实现自由度**: 开发团队可在不影响核心功能的前提下优化实现细节
```

---

## 🟢 次要修正项

### 修正5: 设备类型枚举统一

**PRD/TDD/TEST/UAT统一使用的设备类型**:

```rust
pub enum DeviceType {
    Smartphone {           // 智能手机
        os: MobileOS,      // Android / iOS
        battery_level: u8,
        is_charging: bool,
    },
    Tablet {               // 平板电脑
        os: MobileOS,
        battery_level: u8,
        is_charging: bool,
    },
    Laptop {               // 笔记本电脑
        os: DesktopOS,     // Linux / Windows / MacOS
        battery_level: u8,
        is_charging: bool,
    },
    Desktop {              // 台式电脑
        os: DesktopOS,
    },
    Server {               // 服务器
        datacenter: bool,
    },
    IoTDevice {            // IoT设备
        power_source: PowerSource,  // Battery / USB / AC / Solar
        memory_kb: u32,
    },
    DevelopmentBoard {     // 开发板（如树莓派）
        model: String,     // "Raspberry Pi 4"
        memory_mb: u32,
        architecture: Architecture,  // ARM / x86 / x64 / RISCV
    },
}
```

所有文档统一使用此枚举定义。

---

### 修正6: 测试环境描述统一

**统一的测试环境配置**:

| 环境类型 | 配置 | 用途 | 文档 |
|----------|------|------|------|
| **开发环境** | 开发机 + 2-3台测试设备 | 日常开发和单元测试 | TDD |
| **集成测试环境** | 5-10台不同平台设备 | 集成测试和跨平台测试 | TEST |
| **性能测试环境** | 专用测试设备 + 性能监控工具 | 性能基准测试 | TEST |
| **UAT环境** | Beta用户真实设备 | 用户验收测试 | UAT |

---

## 📊 修正影响矩阵

| 修正项 | PRD | TDD | TEST | UAT | 优先级 |
|--------|-----|-----|------|-----|--------|
| 修正1: 功能覆盖 | 🔴 重要 | ✅ 无影响 | 🔴 重要 | 🔴 重要 | P0 |
| 修正2: 性能指标 | 🟡 中等 | ✅ 无影响 | 🔴 重要 | 🔴 重要 | P0 |
| 修正3: 术语统一 | 🟡 中等 | 🟡 中等 | 🟡 中等 | 🟡 中等 | P1 |
| 修正4: 设计范围 | 🟡 中等 | 🔴 重要 | ✅ 无影响 | ✅ 无影响 | P1 |
| 修正5: 设备类型 | 🟢 轻微 | 🟢 轻微 | 🟢 轻微 | 🟢 轻微 | P2 |
| 修正6: 测试环境 | ✅ 无影响 | 🟢 轻微 | 🟢 轻微 | 🟢 轻微 | P2 |

---

## 🔧 实施建议

### 阶段1: 立即修正（本周完成）
1. ✅ 创建本修正文档
2. 🔲 更新PRD: 调整F9/F10优先级，添加术语表
3. 🔲 更新TEST: 补充成本感知测试，细化群组规模测试
4. 🔲 更新UAT: 补充对应验收用例
5. 🔲 团队审阅修正内容

### 阶段2: 文档重发布（下周完成）
1. 🔲 发布PRD v1.1
2. 🔲 发布TDD v1.1（重组章节结构）
3. 🔲 发布TEST v1.1
4. 🔲 发布UAT v1.1
5. 🔲 更新所有文档交叉引用

### 阶段3: 验证（Sprint 1）
1. 🔲 开发团队确认TDD可实施
2. 🔲 测试团队确认TEST可执行
3. 🔲 产品团队确认PRD完整
4. 🔲 收集反馈，迭代优化

---

## 📝 修正后的版本号

- PRD: v1.0 → v1.1
- TDD: v1.0 → v1.1
- TEST: v1.0 → v1.1
- UAT: v1.0 → v1.1
- ERRATA: v1.1（新增）

---

## ✅ 修正检查清单

**PRD修正检查**:
- [ ] F9成本感知路由优先级更新为"P1 - Phase 2"
- [ ] F10分布式存储标记为"P3 - v2.0"
- [ ] 性能指标统一为≥99.9%送达率
- [ ] 群组规模明确分级: 10/50/100/500/1000
- [ ] 文件传输明确分级: <5MB/<50MB/<100MB
- [ ] 新增第9章术语表
- [ ] 新增2.6设计原则和约束

**TDD修正检查**:
- [ ] 重组章节为"核心设计"+"实现参考"
- [ ] 每个技术术语首次出现时引用PRD术语表
- [ ] 设备类型枚举与PRD一致
- [ ] 移除或标记过度实现细节
- [ ] 术语引用添加到章节开头

**TEST修正检查**:
- [ ] 补充5.5成本感知路由测试
- [ ] 补充5.4群组规模压力测试（10/50/100/200/500人）
- [ ] 补充5.5大文件传输测试（5MB/50MB/100MB）
- [ ] 性能指标统一为≥99.9%
- [ ] 所有测试用例引用统一术语

**UAT修正检查**:
- [ ] 补充3.2.3成本感知路由验收
- [ ] 补充4.4群组规模验收
- [ ] 补充4.5文件传输验收
- [ ] 性能验收标准统一
- [ ] 术语使用一致

---

## 🎯 预期效果

修正完成后，四份文档将达到：

1. **一致性**: 所有性能指标、术语、定义完全一致
2. **完整性**: 功能覆盖、测试覆盖、验收覆盖无遗漏
3. **可追溯性**: PRD → TDD → TEST → UAT 逻辑链条清晰
4. **可实施性**: 开发、测试、验收标准明确可执行
5. **专业性**: 技术深度适当，边界清晰

---

## 📞 联系方式

如对本修正文档有疑问或建议，请联系：
- 产品负责人: [Product Manager]
- 技术负责人: [Tech Lead]
- 测试负责人: [QA Manager]

---

**文档修订历史**:
- v1.1 (2025-12-19): 创建修正文档，解决四份文档间不一致性问题